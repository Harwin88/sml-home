<div class="search-container">

  <!-- Filtros activos -->
  <div class="active-filters-bar" *ngIf="activeFiltersCount > 0">
    <span class="filter-count">{{ activeFiltersCount }} filtro(s) activo(s)</span>
    <button class="btn-clear" (click)="clearFilters()">Limpiar todo</button>
  </div>

  <div class="content-wrapper">

    <!-- Sidebar con filtros -->
    <aside class="filters-sidebar">

      <!-- Filtro por Categor√≠as (Solo Nodos Hoja) -->
      <div class="filter-section">
        <h3>üìã Categor√≠as de Servicio</h3>
        <p style="font-size: 0.85rem; color: #7f8c8d; margin-bottom: 15px;">
          Selecciona una categor√≠a
        </p>

        <!-- Buscador de categor√≠as (para filtrar la lista de categor√≠as) -->
        <div class="category-search-box">
          <input type="text" 
                 [formControl]="categorySearchControl" 
                 placeholder="üîç Buscar categor√≠a..."
                 class="category-search-input" />
        </div>

        <div *ngIf="loadingCategories" class="loading-small">
          Cargando categor√≠as...
        </div>

        <!-- Mostrar solo categor√≠as nodo hoja como filtros seleccionables (filtradas por b√∫squeda) -->
        <div *ngIf="!loadingCategories && subcategoryFilters.length > 0" class="leaf-categories-list">
          <label *ngFor="let category of filteredSubcategoryFilters" class="checkbox-label"
            [class.selected]="category.selected">
            <input type="checkbox" [checked]="category.selected" (change)="toggleSubcategory(category)" />
            <span class="subcategory-icon" *ngIf="category.icon">{{ category.icon }}</span>
            <span class="subcategory-name">{{ category.name }}</span>
            <span class="parent-badge" *ngIf="category.parentName">{{ category.parentName }}</span>
          </label>
        </div>

        <!-- Mensaje cuando no hay categor√≠as que coincidan con la b√∫squeda -->
        <div *ngIf="!loadingCategories && subcategoryFilters.length > 0 && filteredSubcategoryFilters.length === 0" class="no-categories">
          <p>No se encontraron categor√≠as con ese t√©rmino</p>
        </div>

        <!-- Mensaje cuando no hay categor√≠as disponibles -->
        <div *ngIf="!loadingCategories && subcategoryFilters.length === 0" class="no-categories">
          <p>No hay categor√≠as disponibles</p>
        </div>
      </div>

      <!-- Filtro por Rating -->
      <div class="filter-section">
        <h3>‚≠ê Calificaci√≥n M√≠nima</h3>
        <div class="rating-filter">
          <input type="range" min="0" max="5" step="0.5" [(ngModel)]="minRating" (ngModelChange)="applyFilters()"
            class="rating-slider" />
          <div class="rating-value">
            <span *ngIf="minRating > 0">{{ minRating }} ‚≠ê o m√°s</span>
            <span *ngIf="minRating === 0">Cualquier calificaci√≥n</span>
          </div>
        </div>
      </div>

      <!-- Filtro por Verificaci√≥n -->
      <div class="filter-section">
        <h3>‚úì Estado</h3>
        <label class="checkbox-label">
          <input type="checkbox" [(ngModel)]="showOnlyVerified" (ngModelChange)="applyFilters()" />
          <span>Solo proveedores verificados</span>
        </label>
      </div>

      <!-- Filtro por Ubicaci√≥n -->
      <div class="filter-section">
        <h3>üìç Mi Ubicaci√≥n</h3>
        <div class="location-filter">
          <div *ngIf="!geolocationSupported" class="location-not-supported">
            <p class="location-message">Tu navegador no soporta geolocalizaci√≥n</p>
          </div>
          
          <div *ngIf="geolocationSupported">
            <div *ngIf="!userLocation && !isGettingLocation && !locationError" class="location-action">
              <button class="btn-location" (click)="getUserLocation()" type="button">
                <span class="location-icon">üìç</span>
                <span>Obtener mi ubicaci√≥n</span>
              </button>
            </div>

            <div *ngIf="isGettingLocation" class="location-loading">
              <div class="location-spinner"></div>
              <p class="location-message">Obteniendo ubicaci√≥n...</p>
            </div>

            <div *ngIf="locationError" class="location-error">
              <p class="location-message error-text">{{ locationError }}</p>
              <button class="btn-location-small" (click)="getUserLocation()" type="button">
                Intentar de nuevo
              </button>
            </div>

            <div *ngIf="userLocation && !isGettingLocation" class="location-success">
              <div class="location-info">
                <p class="location-message success-text">
                  <span class="location-icon">‚úÖ</span>
                  Ubicaci√≥n obtenida
                </p>
                <p class="location-coords">
                  {{ userLocation.latitude.toFixed(6) }}, {{ userLocation.longitude.toFixed(6) }}
                </p>
                <p class="location-accuracy" *ngIf="userLocation.accuracy">
                  Precisi√≥n: {{ (userLocation.accuracy / 1000).toFixed(2) }} km
                </p>
              </div>
              <button class="btn-location-clear" (click)="clearLocation()" type="button">
                Limpiar ubicaci√≥n
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Filtro por Rango de Precio -->
      <div class="filter-section">
        <h3>üí∞ Rango de Precio</h3>
        <div class="price-filters">
          <label *ngFor="let range of priceRanges" class="radio-label" [class.selected]="selectedPriceRange === range">
            <input type="radio" name="priceRange" [value]="range" [(ngModel)]="selectedPriceRange"
              (ngModelChange)="applyFilters()" />
            <span class="price-badge" [ngClass]="range">{{ range }}</span>
          </label>
          <label class="radio-label">
            <input type="radio" name="priceRange" value="" [(ngModel)]="selectedPriceRange" (ngModelChange)="applyFilters()" />
            <span>Todos</span>
          </label>
        </div>
      </div>

    </aside>

    <!-- Resultados -->
    <main class="results-section">

      <!-- Loading -->
      <div *ngIf="loading" class="loading">
        <div class="spinner"></div>
        <p>Buscando proveedores...</p>
      </div>

      <!-- Error -->
      <div *ngIf="error && !loading" class="error">
        {{ error }}
      </div>

      <!-- Sin resultados -->
      <div *ngIf="!loading && !error && filteredProviders.length === 0" class="no-results">
        <h3>üòï No se encontraron proveedores</h3>
        <p>Intenta ajustar los filtros o realiza una nueva b√∫squeda</p>
        <button class="btn-primary" (click)="clearFilters()">Limpiar filtros</button>
      </div>

      <!-- Resultados -->
      <div *ngIf="!loading && filteredProviders.length > 0">

        <!-- Contador de resultados -->
        <div class="results-header">
          <h2>{{ filteredProviders.length }} proveedor(es) encontrado(s)</h2>
        </div>

        <!-- Grid de proveedores -->
        <div class="providers-grid">
          <div *ngFor="let provider of filteredProviders" class="provider-card">

            <!-- Imagen -->
            <div class="provider-image">
              <img [src]="provider.photoUrl || 'assets/default-avatar.png'" [alt]="provider.name"
                (error)="onImageError($event)" />
              <span *ngIf="provider.isVerified" class="verified-badge">
                ‚úì Verificado
              </span>
            </div>

            <!-- Info -->
            <div class="provider-info">
              <h3 class="provider-name">{{ provider.name }}</h3>

              <!-- Rating -->
              <div class="rating">
                <span class="stars">‚≠ê {{ provider.rating.toFixed(1) }}/5</span>
                <span class="reviews">({{ provider.totalReviews }} rese√±as)</span>
              </div>

              <!-- Experiencia -->
              <p class="experience">
                <span class="icon">üíº</span>
                {{ provider.experienceYears }} a√±os de experiencia
              </p>

              <!-- Categor√≠as -->
              <div class="provider-categories">
                <span *ngFor="let category of provider.categories" class="category-tag"
                  [class.highlighted]="isCategoryHighlighted(category)">
                  {{ category }}
                </span>
              </div>

              <!-- Precio -->
              <div class="price-info">
                <span class="price-badge" [ngClass]="provider.priceRange">
                  {{ provider.priceRange }}
                </span>
                <span *ngIf="provider.hourlyRate" class="hourly-rate">
                  üíµ ${{ formatPrice(provider.hourlyRate) }}/hora
                </span>
              </div>

              <!-- Acciones -->
              <div class="provider-actions">
                <a [href]="'tel:' + provider.phone" class="btn btn-call">
                  üìû Llamar
                </a>
                <a [routerLink]="['/provider', provider.documentId]" class="btn btn-details">
                  Ver Perfil
                </a>
                <button (click)="openRatingModal(provider)" class="btn btn-rate">
                  ‚≠ê Calificar
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Paginaci√≥n -->
        <div class="pagination" *ngIf="totalPages > 1">
          <button class="btn-page" [disabled]="currentPage === 1" (click)="goToPage(currentPage - 1)">
            ‚Üê Anterior
          </button>

          <span class="page-info">
            P√°gina {{ currentPage }} de {{ totalPages }}
          </span>

          <button class="btn-page" [disabled]="currentPage === totalPages" (click)="goToPage(currentPage + 1)">
            Siguiente ‚Üí
          </button>
        </div>
      </div>

    </main>
  </div>
</div>

<!-- Modal de calificaci√≥n -->
<app-rating-modal 
  *ngIf="showRatingModal && selectedProviderForRating"
  [providerName]="selectedProviderForRating.name"
  [providerId]="selectedProviderForRating.documentId"
  (close)="closeRatingModal()"
  (submit)="onSubmitRating($event)">
</app-rating-modal>